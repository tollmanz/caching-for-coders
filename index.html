<!DOCTYPE html>

<!--
  Google HTML5 slide template

  Authors: Luke Mahé (code)
           Marcin Wichary (code and design)
           
           Dominic Mazzoni (browser compatibility)
           Charles Chen (ChromeVox support)

  URL: http://code.google.com/p/html5slides/
-->

<html>
	<head>
		<title>Caching for Coders | How, What, and When to Cache in WordPress</title>

		<meta charset='utf-8'>
		<script src='http://html5slides.googlecode.com/svn/trunk/slides.js'></script>
	</head>

	<style>
			/* Your individual styles here, or just use inline styles if that’s
				   what you want. */
	</style>

<body style='display: none;'>

	<section class='slides layout-regular template-default'>

		<article class='title-page'>
			<h1>Caching for Coders: <br /> How, What, and When to Cache in WordPress</h1>
			<h3>Zack Tollman, 10up LLC</h3>
		</article>

		<article>
			<h3>What We Are Talking About</h3>

			<ul>
				<li>
					Improving site performance through object (fragment) caching
					<ul>
						<li>How to cache</li>
						<li>What to cache</li>
						<li>When to cache</li>
					</ul>
				</li>
				<li>
					Not talking about caching plugins or server setups
					<ul>
						<li>
							<a href="http://wordpress.tv/2010/07/10/scott-oshaughnessy-caching-wordpress-boulder10/">
								Chris Scott and Sean O’Shaughnessy: Caching in WordPress
							</a>
						</li>
					</ul>
				</li>

			</ul>
		</article>

		<article>
			<h3>How to Cache</h3>

			<p>Transients <a href="http://codex.wordpress.org/Transients_API" target="_blank"><img src="images/link.png" /></a></p>

			<ul>
				<li>set_transient, get_transient, delete_transient</li>
				<li>Uses the database if an object cache is not present</li>
			</ul>

			<pre>
function zt_display_scoring_leaders() {
    $scoring_leaders = get_transient( 'zt-scoring-leaders' );
    if ( false === $scoring_leaders ) {
        $scoring_leaders = zt_get_scoring_leaders();
        set_transient( 'zt-scoring-leaders', $scoring_leaders, 300 );
    }

    return $scoring_leaders;
}</pre>

		</article>

		<article>
			<h3>How to Cache</h3>

			<p>WP_Object_Cache</p>

			<ul>
				<li>wp_cache_set, wp_cache_get, wp_cache_delete (amongst others)</li>
				<li>Success depends on server environment</li>
			</ul>

			<pre>
function zt_display_scoring_leaders() {
    $scoring_leaders = wp_cache_get( 'zt-scoring-leaders', 'zt-stats' );
    if ( false === $scoring_leaders ) {
        $scoring_leaders = zt_get_scoring_leaders();
        wp_cache_set( 'zt-scoring-leaders', $scoring_leaders, 'zt-stats', 300 );
    }

    return $scoring_leaders;
}</pre>
		</article>

		<article>
			<h3>What to Cache</h3>
			<ul>
				<li>
					Requests to external services
					<ul>
						<li>wp_remote_get, new WP_Http, curl_init, fsockopen</li>
					</ul>
				</li>
				<li>
					Expensive queries
					<ul>
						<li>'post__not_in', 'tax_query'</li>
						<li>Identify slow queries with Debug Bar</li>
					</ul>
				</li>
				<li>
					Repeated routines/queries
					<ul>
						<li>first image in post</li><!-- todo: better examples -->
					</ul>
				</li>
				<li>
					Infrequently updated data
					<ul>
						<li>menus <a href="http://hitchhackerguide.com/2011/10/07/caching-wordpress-navigation-menus-wp_nav_menu-wrapper/" target="_blank"><img src="images/link.png" /></a>, related posts, list of teams</li>
					</ul>
				</li>
			</ul>
		</article>

		<article>
			<!-- todo: is this necessary? might be kinda obvious -->
			<h3>What NOT to Cache</h3>

			<ul>
				<li>Real-time data</li>
				<li>Objects that are personalized</li>
			</ul>
		</article>

		<article>
			<h3>When to Cache</h3>

			<ul>
				<li>The goal is to reduce the server's workload</li>
				<li>Ideally, refresh cache ONLY when data is added/changed</li>
				<li>How can you remove queries or expensive processes?</li>
			</ul>

			<h3 class="second-header">Gameplan</h3>

			<ul>
				<li>Only run intensive processes when absolutely necessary</li>
				<li>Avoid caching on front end page requests</li>
				<li>Design to fail gracefully</li>
			</ul>
		</article>

		<!-- todo: it might good to first show the "common" pattern to then show what we can do to make this better. -->

		<article>
			<h3>When to Cache - A Common Solution</h3>

			<p>Cache when the data is not cached</p>

			<p class="code-caption">functions.php</p>
			<pre>
function zt_get_latest_tweet() {
    $tweet = get_transient( 'zt-latest-tweet' );
    if ( false === $favorites ) {
        $tweet = zt_request_latest_tweet(); // Talk to Twitter
        set_transient( 'zt-latest-tweet', $tweet, 300 );
    }
    return $tweet;
}</pre>

			<p class="code-caption">sidebar.php</p>
			<pre>
&lt;h3&gt;Latest Tweet:&lt;/h3&gt;
&lt;p&gt;&lt;?php echo zt_get_latest_tweet(); ?&gt;&lt;/p&gt;</pre>

		</article>

		<article>
			<h3>When to Cache - When the Data Changes</h3>

			<ul>
				<li>
					Generate the data on an admin event
					<ul>
						<li>Only generates the data once</li>
						<li>Reduces the chance of front end generation</li>
					</ul>
				</li>
				<li>
					Helpful Events/Hooks
					<ul>
						<li>Publishing posts: publish_post</li>
						<li>Changing post status: transition_post_status</li>
						<li>Creating terms: created_{$taxonomy}</li>
						<li>Updating terms: edited_{$taxonomy}</li>
					</ul>
				</li>
			</ul>
		</article>

		<article>
			<h3>When to Cache - When the Data Changes</h3>

			<pre>
function zt_set_best_reviewed_games( $new_status, $old_status, $post ) {
    if ( 'zt-game' != $post->post_type )
        return false;
    zt_determine_best_reviewed_games();
}

function zt_determine_best_reviewed_games() {
    /* Get best reviewed games; set to $top_games */
    set_transient( 'zt-top-games', $top_games );
    return $top_games;
}

add_action( 'transition_post_status', 'zt_set_best_reviewed_games', 10, 3 );</pre>
		</article>

		<article>
			<h3>When to Cache - On an Interval</h3>

			<ul>
				<li>
					Use scheduled events to cache unpredictable data
					<ul>
						<li>e.g., external data, undetectable user events</li>
					</ul>
				</li>
				<li>Avoids unnecessary requests</li>
				<li>Reduces the chance of front end caching</li>
			</ul>

		</article>

		<article>
			<h3>When to Cache - On an Interval</h3>

			<pre>
function zt_get_latest_tweet() {
    $tweet = get_transient( 'zt-latest-tweet' );
    if ( false === $favorites ) {
        $tweet = zt_request_latest_tweet(); // Talk to Twitter
        set_transient( 'zt-latest-tweet', $tweet );
    }
    return $tweet;
}

function zt_schedule_tweet_retrieval() {
    if ( ! wp_next_scheduled( 'zt_latest_tweet_scheduled' ) )
        wp_schedule_event( time(), 'hourly', 'zt_latest_tweet_scheduled' );
    add_action( 'zt_latest_tweet_scheduled', 'zt_request_latest_tweet' );
}
add_action( 'init', 'zt_schedule_tweet_retrieval' );</pre>
		</article>

		<article>
			<h3>When to Cache - Failing Gracefully</h3>
			
			<ul>
				<li>Never trust that data is in the cache</li>
				<li>
					Have a backup plan
					<ul>
						<li>Display placeholder text</li>
						<li>Get from backup storage (Options API)</li>
						<li>Regenerate data</li>
					</ul>
				</li>
			</ul>
		</article>

		<article>
			<h3>When to Cache - Failing Gracefully</h3>

			<pre>
function zt_display_latest_tweet() {
    $tweet = get_transient( 'zt-latest-tweet' );
    if ( false === $tweet )
        return $tweet;
    else
        return 'Latest Tweet Unavailable';
}</pre>
			<pre>
function zt_display_latest_tweet() {
    $tweet = get_transient( 'zt-latest-tweet' );
    if ( false === $tweet )
        return $tweet;
    else
        return zt_get_latest_tweet();
}</pre>
		</article>

	</section>

</body>
</html>